- name: Upgrade worker nodes
  # Do not upgrade terabox automatically
  hosts: workers:!storage
  remote_user: root

  # Upgrade hosts one by one
  strategy: host_pinned
  serial: 1

  tasks:
  - name: Upgrade system
    register: upgraded
    community.general.pacman:
      upgrade: true
      update_cache: true
  - meta: end_host
    when: |
      ('packages' not in upgraded) or (upgraded.packages | length == 0)

  - name: Print upgraded packages 
    ansible.builtin.debug:
      var: upgraded.packages

  - name: Restart container runtime
    when: |
      upgraded.packages | intersect(['kubelet', 'cri-o']) | length > 0
    ansible.builtin.systemd:
      name: crio
      state: restarted
  - name: Restart kubelet
    when: |
      upgraded.packages | intersect(['kubelet', 'cri-o']) | length > 0
    ansible.builtin.systemd:
      name: kubelet
      state: restarted
  - name: Reboot node if kernel was upgraded
    when: |
      upgraded.packages | intersect(['linux', 'linux-lts']) | length > 0
    ansible.builtin.reboot: {}
  - name: Wait until DNS is healthy
    delegate_to: gigabox
    ansible.builtin.shell:
      cmd: |
        kubectl wait --timeout=5m --for=condition=ready -n dnscrypt-proxy pods --all && \
        kubectl wait --timeout=2m --for=condition=ready -n dnsmasq pods --selector=app.kubernetes.io/component=dns
